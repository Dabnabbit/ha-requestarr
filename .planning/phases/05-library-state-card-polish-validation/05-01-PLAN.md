---
phase: 05-library-state-card-polish-validation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/requestarr/frontend/requestarr-card.js
autonomous: true
requirements:
  - REQT-05
  - CARD-05

must_haves:
  truths:
    - "Search results with in_library=true show a green 'In Library' pill overlay on their poster/avatar"
    - "In-library items show a grayed-out disabled button labeled 'In Library' instead of the Request button"
    - "Behavior is identical across movies, TV, and music result rows"
    - "The card visual editor appears when editing the card in Lovelace"
    - "The editor shows only toggles for services that are actually configured (sensor.requestarr_* prefix match)"
    - "Saving editor config dispatches config-changed event and Lovelace persists the change"
  artifacts:
    - path: "custom_components/requestarr/frontend/requestarr-card.js"
      provides: "Updated card with in-library badges, disabled button, and working editor"
      contains: "badge-in-library"
  key_links:
    - from: "_getItemState()"
      to: "item.in_library"
      via: "returns 'in_library' when item.in_library === true"
      pattern: "in_library.*return.*in_library"
    - from: "_renderStatus()"
      to: "key parameter"
      via: "key passed in from caller, no internal recalculation"
      pattern: "_renderStatus\\(state, key, item\\)"
    - from: "RequestarrCardEditor"
      to: "config-changed event"
      via: "dispatchEvent on _valueChanged"
      pattern: "config-changed"
---

<objective>
Add "In Library" visual indicators to all search result rows and implement the visual card editor.

Purpose: Completes the user-visible library state feature (REQT-05) and the Lovelace card editor (CARD-05). Both are pure frontend changes to requestarr-card.js with no backend changes needed — the backend already emits `in_library` in every search result.

Output: Updated requestarr-card.js with green pill badge on in-library posters/avatars, disabled "In Library" button replacing the Request button for in-library items, and a working RequestarrCardEditor with service toggles and title field.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-library-state-card-polish-validation/05-CONTEXT.md
@.planning/phases/05-library-state-card-polish-validation/05-RESEARCH.md

<interfaces>
<!-- Key existing code in requestarr-card.js the executor must work with. -->
<!-- Do NOT explore — use these directly. -->

Current _getItemState() — MUST BE CHANGED:
```javascript
_getItemState(item) {
  const key =
    item.foreign_artist_id != null
      ? String(item.foreign_artist_id)
      : String(item.tmdb_id != null ? item.tmdb_id : item.tvdb_id);
  const reqState = this._requesting[key];
  if (reqState === "requested") return "requested";
  if (!item.in_library) return "not_in_library";
  if (item.has_file) return "available";   // <-- remove these two cases
  return "monitored";                       // <-- remove this case
}
```

Current _renderStatus(state, item) — MUST BE CHANGED:
```javascript
_renderStatus(state, item) {
  const key = String(item.tmdb_id != null ? item.tmdb_id : item.tvdb_id);  // BUG: wrong for music
  const isRequesting = this._requesting[key] === "requesting";
  switch (state) {
    case "available":   return html`<span class="badge badge-available">Available</span>`;
    case "monitored":   return html`<span class="badge badge-monitored">Monitored</span>`;
    case "requested":   return html`<span class="badge badge-requested">Requested</span>`;
    case "not_in_library":
    default:
      return html`<button class="req-btn" ?disabled="${isRequesting}"
        @click="${() => { this._dialogItem = item; }}">
        ${isRequesting ? "Requesting\u2026" : "Request"}
      </button>`;
  }
}
```

Current _renderResultRow(item) — needs badge + key fix:
```javascript
_renderResultRow(item) {
  const state = this._getItemState(item);
  const key = String(item.tmdb_id != null ? item.tmdb_id : item.tvdb_id);
  const reqErr = this._requestError[key];
  return html`
    <div class="result-row">
      <div class="poster-wrap">
        ${item.poster_url ? html`<img class="poster" .../>` : ""}
        <div class="poster-placeholder"></div>
        <!-- badge goes here -->
      </div>
      <div class="result-info">
        ...
        ${this._renderStatus(state, item)}   <!-- needs: _renderStatus(state, key, item) -->
        ...
      </div>
    </div>
  `;
}
```

Current _renderMusicResultRow(item) — needs badge + key fix:
```javascript
_renderMusicResultRow(item) {
  const key = String(item.foreign_artist_id);
  const state = this._getItemState(item);
  return html`
    <div class="result-row music-result-row">
      <div class="avatar-wrap">
        ${item.poster_url ? html`<img class="avatar" .../>` : ""}
        <div class="avatar-placeholder" ...>${initial}</div>
        <!-- badge goes here -->
      </div>
      <div class="result-info">
        ...
        ${this._renderStatus(state, item)}   <!-- needs: _renderStatus(state, key, item) -->
        ...
      </div>
    </div>
  `;
}
```

Current RequestarrCardEditor stub — MUST BE REPLACED:
```javascript
class RequestarrCardEditor extends LitElement {
  static get properties() { return { hass: {}, config: {} }; }
  setConfig(config) { this.config = config; }
  render() { return html``; }
}
```

Current CARD_VERSION: "0.4.0" — bump to "0.5.0"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix _getItemState, _renderStatus, and add In Library badge to poster/avatar rows</name>
  <files>custom_components/requestarr/frontend/requestarr-card.js</files>
  <action>
Make the following targeted changes to requestarr-card.js. Read the file first, then apply all changes in a single write.

**Change 1 — Update CARD_VERSION to "0.5.0"** (line ~14)

**Change 2 — Fix _getItemState():**
Replace the three return cases at the end with a single check. The function should return exactly three states:
- `"requested"` — item was session-requested (check `this._requesting[key]` first)
- `"in_library"` — item.in_library is true (id > 0 from arr lookup) — applies to ALL media types, replaces both `"available"` and `"monitored"` states
- `"not_in_library"` — default

```javascript
_getItemState(item) {
  const key =
    item.foreign_artist_id != null
      ? String(item.foreign_artist_id)
      : String(item.tmdb_id != null ? item.tmdb_id : item.tvdb_id);
  const reqState = this._requesting[key];
  if (reqState === "requested") return "requested";
  if (item.in_library) return "in_library";
  return "not_in_library";
}
```

**Change 3 — Fix _renderStatus() signature and cases:**
Add `key` as the second parameter (between `state` and `item`). Remove the internal key recalculation. Remove the `"available"` and `"monitored"` cases. Add `"in_library"` case with disabled button. The `"requested"` case returns the orange badge. Keep `"not_in_library"` as default.

```javascript
_renderStatus(state, key, item) {
  const isRequesting = this._requesting[key] === "requesting";
  switch (state) {
    case "in_library":
      return html`<button class="req-btn req-btn-in-library" disabled>In Library</button>`;
    case "requested":
      return html`<span class="badge badge-requested">Requested</span>`;
    case "not_in_library":
    default:
      return html`<button
        class="req-btn"
        ?disabled="${isRequesting}"
        @click="${() => { this._dialogItem = item; }}"
      >${isRequesting ? "Requesting\u2026" : "Request"}</button>`;
  }
}
```

**Change 4 — Fix _renderResultRow() to add badge and pass key:**
Inside `.poster-wrap`, after the `<div class="poster-placeholder"></div>`, add:
```javascript
${item.in_library
  ? html`<span class="badge-in-library">In Library</span>`
  : ""}
```
Change the `_renderStatus` call from `_renderStatus(state, item)` to `_renderStatus(state, key, item)`.

**Change 5 — Fix _renderMusicResultRow() to add badge and pass key:**
Inside `.avatar-wrap`, after the `<div class="avatar-placeholder" ...>` element, add:
```javascript
${item.in_library
  ? html`<span class="badge-in-library">In Library</span>`
  : ""}
```
Change the `_renderStatus` call from `_renderStatus(state, item)` to `_renderStatus(state, key, item)`.

**Change 6 — Add CSS for badge-in-library and req-btn-in-library:**
Append to the existing `static get styles()` return value, inside the css template literal, after the existing `.loading` rule:

```css
/* In Library badge overlay on poster/avatar */
.badge-in-library {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: #4caf50;
  color: white;
  font-size: 0.6rem;
  font-weight: 700;
  text-align: center;
  padding: 2px 0;
  letter-spacing: 0.03em;
}

/* Disabled "In Library" button state */
.req-btn-in-library {
  background: #9e9e9e;
  color: white;
  cursor: default;
}
.req-btn-in-library:hover {
  filter: none;
}
```

Do NOT add height to `.poster-wrap` or `.avatar-wrap`. Both already have `position: relative` and `overflow: hidden` — the badge uses absolute positioning within them.

Remove the `.badge-available` and `.badge-monitored` CSS rules since those states no longer exist.
  </action>
  <verify>
grep -n "badge-in-library\|in_library\|req-btn-in-library\|0\.5\.0" /home/dab/Projects/ha-requestarr/custom_components/requestarr/frontend/requestarr-card.js | head -30
  </verify>
  <done>
- CARD_VERSION is "0.5.0"
- _getItemState returns exactly 3 states: "requested", "in_library", "not_in_library"
- _renderStatus has signature (state, key, item) — no internal key recalculation
- "in_library" case renders disabled button with class "req-btn req-btn-in-library"
- Both _renderResultRow and _renderMusicResultRow: pass key to _renderStatus, include badge-in-library span inside poster-wrap/avatar-wrap
- .badge-in-library CSS exists with position: absolute, bottom: 0, left/right: 0, background: #4caf50
- .badge-available and .badge-monitored CSS rules are removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement RequestarrCardEditor with service toggles and title field</name>
  <files>custom_components/requestarr/frontend/requestarr-card.js</files>
  <action>
Replace the existing stub `RequestarrCardEditor` class (lines ~719-731 in current file) with the full implementation below. Keep the `customElements.define` and `window.customCards` lines unchanged.

The editor must:
1. Detect configured services by checking `this.hass.states` for keys starting with `sensor.requestarr_radarr`, `sensor.requestarr_sonarr`, or `sensor.requestarr_lidarr` (prefix match, NOT exact match — HA may add numeric suffixes)
2. Show a toggle (checkbox) for each configured service: "Show Radarr tab", "Show Sonarr tab", "Show Lidarr tab"
3. Show a text input for card title (default "Requestarr")
4. On any change, dispatch a `config-changed` event with `{ config: newConfig }` on `event.detail`
5. Use simple HTML only — no LitElement forms or HA selectors needed

```javascript
class RequestarrCardEditor extends LitElement {
  static get properties() {
    return { hass: {}, config: {} };
  }

  setConfig(config) {
    this.config = { header: "Requestarr", ...config };
  }

  _isServiceConfigured(service) {
    if (!this.hass) return false;
    return Object.keys(this.hass.states).some((k) =>
      k.startsWith(`sensor.requestarr_${service}`)
    );
  }

  _fireConfigChanged(newConfig) {
    const ev = new Event("config-changed", { bubbles: true, composed: true });
    ev.detail = { config: newConfig };
    this.dispatchEvent(ev);
  }

  _onToggle(ev) {
    const key = ev.target.dataset.configKey;
    const newConfig = { ...this.config, [key]: ev.target.checked };
    this._fireConfigChanged(newConfig);
  }

  _onTitleInput(ev) {
    const newConfig = { ...this.config, header: ev.target.value };
    this._fireConfigChanged(newConfig);
  }

  render() {
    if (!this.config || !this.hass) return html``;
    const services = [
      { id: "radarr", label: "Show Radarr tab", key: "show_radarr" },
      { id: "sonarr", label: "Show Sonarr tab", key: "show_sonarr" },
      { id: "lidarr", label: "Show Lidarr tab", key: "show_lidarr" },
    ];
    const configuredServices = services.filter((s) =>
      this._isServiceConfigured(s.id)
    );
    return html`
      <div class="editor">
        <div class="editor-row">
          <label class="editor-label">Card Title</label>
          <input
            class="editor-input"
            type="text"
            .value="${this.config.header || "Requestarr"}"
            @input="${this._onTitleInput}"
          />
        </div>
        ${configuredServices.map(
          (s) => html`
            <div class="editor-row editor-row-toggle">
              <label>
                <input
                  type="checkbox"
                  data-config-key="${s.key}"
                  .checked="${this.config[s.key] !== false}"
                  @change="${this._onToggle}"
                />
                ${s.label}
              </label>
            </div>
          `
        )}
        ${configuredServices.length === 0
          ? html`<div class="editor-hint">No arr services configured yet. Add the Requestarr integration first.</div>`
          : ""}
      </div>
    `;
  }

  static get styles() {
    return css`
      .editor {
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .editor-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .editor-row-toggle {
        flex-direction: row;
        align-items: center;
      }
      .editor-label {
        font-size: 0.85rem;
        color: var(--secondary-text-color);
        font-weight: 500;
      }
      .editor-input {
        padding: 6px 10px;
        border: 1px solid var(--divider-color);
        border-radius: 6px;
        background: var(--secondary-background-color);
        color: var(--primary-text-color);
        font-size: 0.9rem;
      }
      .editor-hint {
        font-size: 0.8rem;
        color: var(--secondary-text-color);
        font-style: italic;
      }
    `;
  }
}
```

Note: RequestarrCardEditor gets its own `static get styles()` — this is separate from RequestarrCard's styles. Both classes coexist in the same file.

Also update `static getStubConfig()` in `RequestarrCard` to include the new config keys:
```javascript
static getStubConfig() {
  return { header: "Requestarr", show_radarr: true, show_sonarr: true, show_lidarr: true };
}
```
  </action>
  <verify>
grep -n "RequestarrCardEditor\|config-changed\|_isServiceConfigured\|_fireConfigChanged\|show_radarr\|editor-row" /home/dab/Projects/ha-requestarr/custom_components/requestarr/frontend/requestarr-card.js | head -20
  </verify>
  <done>
- RequestarrCardEditor is fully implemented (not a stub)
- _isServiceConfigured uses startsWith prefix match on hass.states keys
- _fireConfigChanged dispatches "config-changed" event with { config: newConfig } on event.detail
- Editor renders title input + service toggle checkboxes (only for configured services)
- getStubConfig includes show_radarr, show_sonarr, show_lidarr keys
- Editor has its own static get styles() with .editor, .editor-row, .editor-input CSS
  </done>
</task>

</tasks>

<verification>
Verify the full card file is syntactically valid JavaScript (no parse errors) and contains all required changes:

```bash
node --check /home/dab/Projects/ha-requestarr/custom_components/requestarr/frontend/requestarr-card.js && echo "SYNTAX OK"
```

Check key changes are present:
```bash
grep -c "badge-in-library\|req-btn-in-library\|config-changed\|_isServiceConfigured\|show_radarr" /home/dab/Projects/ha-requestarr/custom_components/requestarr/frontend/requestarr-card.js
```
</verification>

<success_criteria>
- `node --check requestarr-card.js` exits 0 (no JS syntax errors)
- CARD_VERSION = "0.5.0"
- _getItemState returns only 3 states: "requested", "in_library", "not_in_library"
- _renderStatus(state, key, item) — key is a parameter, no internal recomputation
- Green .badge-in-library pill renders inside .poster-wrap and .avatar-wrap for in_library items
- Disabled .req-btn-in-library button replaces Request button for in_library items
- RequestarrCardEditor renders service toggles (only configured services) and title input
- config-changed event dispatched on every editor change
- No JS parse errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-library-state-card-polish-validation/05-01-SUMMARY.md`
</output>
